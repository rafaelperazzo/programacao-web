M.gradingform_guideeditor={templates:{},eventhandler:null,name:null,Y:null};M.gradingform_guideeditor.init=function(Y,options){M.gradingform_guideeditor.name=options.name;M.gradingform_guideeditor.Y=Y;M.gradingform_guideeditor.templates[options.name]={criterion:options.criteriontemplate,comment:options.commenttemplate};M.gradingform_guideeditor.disablealleditors();Y.on('click',M.gradingform_guideeditor.clickanywhere,'body',null);YUI().use('event-touch',function(Y){Y.one('body').on('touchstart',M.gradingform_guideeditor.clickanywhere);Y.one('body').on('touchend',M.gradingform_guideeditor.clickanywhere)});M.gradingform_guideeditor.addhandlers()};M.gradingform_guideeditor.addhandlers=function(){var Y=M.gradingform_guideeditor.Y,name=M.gradingform_guideeditor.name;if(M.gradingform_guideeditor.eventhandler)M.gradingform_guideeditor.eventhandler.detach();M.gradingform_guideeditor.eventhandler=Y.on('click',M.gradingform_guideeditor.buttonclick,'#guide-'+name+' input[type=submit]',null)};M.gradingform_guideeditor.disablealleditors=function(){var Y=M.gradingform_guideeditor.Y,name=M.gradingform_guideeditor.name;Y.all('#guide-'+name+' .criteria .description input[type=text]:not(.pseudotablink)').each(function(node){M.gradingform_guideeditor.editmode(node,false)});Y.all('#guide-'+name+' .criteria .description textarea').each(function(node){M.gradingform_guideeditor.editmode(node,false)});Y.all('#guide-'+name+' .comments .description textarea').each(function(node){M.gradingform_guideeditor.editmode(node,false)})};M.gradingform_guideeditor.clickanywhere=function(e){if(e.type=='touchstart')return;var el=e.target;if(el.get('tagName')=='INPUT'&&el.get('type')=='submit')return;var container=null;if((container=el.ancestor('.criterionname'))||(container=el.ancestor('.criterionmaxscore'))){el=container.one('input[type=text]')}else if((container=el.ancestor('.criteriondesc'))||(container=el.ancestor('.criteriondescmarkers'))){el=container.one('textarea')}else el=null;if(el){if(el.hasClass('hiddenelement')){M.gradingform_guideeditor.disablealleditors();M.gradingform_guideeditor.editmode(el,true)};return};M.gradingform_guideeditor.disablealleditors()};M.gradingform_guideeditor.editmode=function(el,editmode){var Y=M.gradingform_guideeditor.Y,ta=el;if(!editmode&&ta.hasClass('hiddenelement'))return;if(editmode&&!ta.hasClass('hiddenelement'))return;var pseudotablink='<input type="text" size="1" class="pseudotablink"/>',taplain=ta.next('.plainvalue'),tbplain=null,tb=el.one('.score input[type=text]');if(!taplain&&ta.get('name')!=''){ta.insert('<div class="plainvalue">'+pseudotablink+'<span class="textvalue">&nbsp;</span></div>','after');taplain=ta.next('.plainvalue');taplain.one('.pseudotablink').on('focus',M.gradingform_guideeditor.clickanywhere);if(tb){tb.get('parentNode').append('<span class="plainvalue">'+pseudotablink+'<span class="textvalue">&nbsp;</span></span>');tbplain=tb.get('parentNode').one('.plainvalue');tbplain.one('.pseudotablink').on('focus',M.gradingform_guideeditor.clickanywhere)}};if(tb&&!tbplain)tbplain=tb.get('parentNode').one('.plainvalue');if(!editmode){var value=Y.Lang.trim(ta.get('value'));if(value.length){taplain.removeClass('empty')}else if(ta.get('name').indexOf('[shortname]')>1){value=M.util.get_string('clicktoeditname','gradingform_guide');taplain.addClass('editname')}else{value=M.util.get_string('clicktoedit','gradingform_guide');taplain.addClass('empty')};taplain.one('.textvalue').set('innerHTML',Y.Escape.html(value).replace(/(?:\r\n|\r|\n)/g,'<br>'));if(tb)tbplain.one('.textvalue').set('innerHTML',Y.Escape.html(tb.get('value')));taplain.removeClass('hiddenelement');ta.addClass('hiddenelement');if(tb){tbplain.removeClass('hiddenelement');tb.addClass('hiddenelement')}}else{try{if(ta.get('name').indexOf('[maxscore]')>1){ta.setStyle('width','25px')}else{var width=parseFloat(ta.get('parentNode').getComputedStyle('width'))-10,height=parseFloat(ta.get('parentNode').getComputedStyle('height'));ta.setStyle('width',Math.max(width,50)+'px');ta.setStyle('height',Math.max(height,30)+'px')}}catch(err){};taplain.addClass('hiddenelement');ta.removeClass('hiddenelement');if(tb){tbplain.addClass('hiddenelement');tb.removeClass('hiddenelement')}};if(editmode)ta.focus()};M.gradingform_guideeditor.buttonclick=function(e,confirmed){var Y=M.gradingform_guideeditor.Y,name=M.gradingform_guideeditor.name;if(e.target.get('type')!='submit')return;M.gradingform_guideeditor.disablealleditors();var chunks=e.target.get('id').split('-'),section=chunks[1],action=chunks[chunks.length-1];if(chunks[0]!=name||(section!='criteria'&&section!='comments'))return;var elements_str;if(section=='criteria'){elements_str='#guide-'+name+' .criteria .criterion'}else if(section=='comments')elements_str='#guide-'+name+' .comments .criterion';var newid=0;if(action=='addcriterion'||action=='addcomment')newid=M.gradingform_guideeditor.calculatenewid(elements_str);var dialog_options={scope:this,callbackargs:[e,true],callback:M.gradingform_guideeditor.buttonclick};if(chunks.length==3&&(action=='addcriterion'||action=='addcomment')){var parentel=Y.one('#'+name+'-'+section);if(parentel.one('>tbody'))parentel=parentel.one('>tbody');if(section=='criteria'){var newcriterion=M.gradingform_guideeditor.templates[name]['criterion'];parentel.append(newcriterion.replace(/\{CRITERION-id\}/g,'NEWID'+newid).replace(/\{.+?\}/g,''))}else if(section=='comments'){var newcomment=M.gradingform_guideeditor.templates[name]['comment'];parentel.append(newcomment.replace(/\{COMMENT-id\}/g,'NEWID'+newid).replace(/\{.+?\}/g,''))};M.gradingform_guideeditor.addhandlers();M.gradingform_guideeditor.disablealleditors();M.gradingform_guideeditor.assignclasses(elements_str);var inputTarget='shortname';if(action=='addcomment')inputTarget='description';var inputTargetId='#guide-'+name+' #'+name+'-'+section+'-NEWID'+newid+'-'+inputTarget;M.gradingform_guideeditor.editmode(Y.one(inputTargetId),true)}else if(chunks.length==4&&action=='moveup'){el=Y.one('#'+name+'-'+section+'-'+chunks[2]);if(el.previous())el.get('parentNode').insertBefore(el,el.previous());M.gradingform_guideeditor.assignclasses(elements_str)}else if(chunks.length==4&&action=='movedown'){el=Y.one('#'+name+'-'+section+'-'+chunks[2]);if(el.next())el.get('parentNode').insertBefore(el.next(),el);M.gradingform_guideeditor.assignclasses(elements_str)}else if(chunks.length==4&&action=='delete'){if(confirmed){Y.one('#'+name+'-'+section+'-'+chunks[2]).remove();M.gradingform_guideeditor.assignclasses(elements_str)}else{dialog_options.message=M.util.get_string('confirmdeletecriterion','gradingform_guide');M.util.show_confirm_dialog(e,dialog_options)}}else return;e.preventDefault()};M.gradingform_guideeditor.assignclasses=function(elements_str){var elements=M.gradingform_guideeditor.Y.all(elements_str);for(var i=0;i<elements.size();i++){elements.item(i).removeClass('first').removeClass('last').removeClass('even').removeClass('odd').addClass(((i%2)?'odd':'even')+((i==0)?' first':'')+((i==elements.size()-1)?' last':''));elements.item(i).all('input[type=hidden]').each(function(node){if(node.get('name').match(/sortorder/))node.set('value',i)})}};M.gradingform_guideeditor.calculatenewid=function(elements_str){var newid=1;M.gradingform_guideeditor.Y.all(elements_str).each(function(node){var idchunks=node.get('id').split('-'),id=idchunks.pop();if(id.match(/^NEWID(\d+)$/))newid=Math.max(newid,parseInt(id.substring(5))+1)});return newid}